#!/usr/bin/env bash

###########
# Functions
###########

# A non-interactive broot (a better tree)
function b {
     br -c :pt "$@"
}

# fzfhx = Use fzf to open files in Helix
function fzfhx {
	result=$(rg --hidden -l "" | fzf --preview 'bat --style=numbers --color=always --line-range :500 {}')
	if [ -z "${result}" ]; then
		# echo "No file selected"
		true
	else
		$EDITOR "${result}"
	fi
}

# rgh = ripgrep on hidden files with pager
function rgh {
	rg -.p "$*" | less -R
}

# ide = Launch "ide": tmux panes with $EDITOR, shell
# Optional argument: A path to cd into
function ide {
	# Change directory if requested
	if [ -n "$1" ]; then
		cd "$1" || return
	fi

	# Generate session name
	SESSION=${PWD##*/}                                  # Current directory basename
	SESSION=${SESSION//./_}                             # Replace illegal characters for tmux session names
	if tmux has-session -t "$SESSION" 2>/dev/null; then # If session already exists, append a counter
		COUNTER=2
		SESSION_WITH_SUFFIX="$SESSION-$COUNTER"
		while tmux has-session -t "$SESSION_WITH_SUFFIX" 2>/dev/null; do
			COUNTER=$((COUNTER + 1))
			SESSION_WITH_SUFFIX="$SESSION-$COUNTER"
		done
		SESSION="$SESSION_WITH_SUFFIX"
	fi

	# Create new tmux session
	tmux new-session -s "$SESSION" -d
	tmux send-keys -t "$SESSION" "$EDITOR ." C-m
	tmux split-window -t "$SESSION" -h
	tmux select-pane -L -t "$SESSION"
	tmux attach-session -t "$SESSION"
}

#########
# Aliases
#########

# Short aliases
alias t='tmux'
alias g='git'
alias h='hx'
alias c='cargo'
alias d='docker'
alias k='kubectl'
alias br='broot'
alias f='fzfhx'
alias r='rgh'
alias i='ide'

# Replace ls with exa
if command -v exa >/dev/null; then
	alias l='exa'
	alias ls='exa'
	alias la='exa -a'
	alias ll='exa -l'
	alias lla='exa -la'
fi

# Aliases to set defaults
alias dust='dust -r'
alias watchexec='watchexec --project-origin .'

# Other helpful/memorable aliases
alias ipaddress='ipconfig getifaddr en0'
alias first='head -1'
alias last='tail -1'
alias hex='hecate'

################
# Local settings
################

if [ -f "$HOME/.shellrc_local" ]; then
	source "$HOME/.shellrc_local"
fi
