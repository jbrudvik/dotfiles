#!/usr/bin/env bash

#############
# Foundations
#############

# Set PATH: Prioritize local over global
export PATH="/usr/local/bin:$PATH"
export PATH="$HOME/.local/bin:$PATH"
export PATH="$HOME/bin:$PATH"

# Add dotfiles directory to PATH
REALPATH=$([ -L "$0" ] && readlink "$0")
REALDIR=$(dirname "$REALPATH")
export PATH="$REALDIR:$PATH"

# Initialize Homebrew
command -v /opt/homebrew/bin/brew >/dev/null && eval "$(/opt/homebrew/bin/brew shellenv)"

#######
# Tools
#######

# Default editor used by other programs
if command -v hx >/dev/null; then
	export EDITOR='hx'
else
	export EDITOR='vim'
fi

# broot file browser
source "$HOME/.config/broot/launcher/bash/br" 2>/dev/null

#######################
# Programming languages
#######################

# Rust
source ~/.cargo/env

# Node via n
export N_PREFIX=$HOME/.n
export PATH="$HOME/.n/bin:$PATH"

# Go
if [ "$(uname -s)" = "Darwin" ]; then
	export GOOS=darwin
	export GOARCH=arm64
	if command -v go >/dev/null; then
		GOPATH=$(go env GOPATH)
		export PATH="$GOPATH/bin:$GOPATH/bin/${GOOS}_${GOARCH}:$PATH"
	else
		export PATH=$PATH:/usr/local/go/bin
	fi
else
	export PATH=$PATH:"$HOME/.go/bin"
	export GOPATH="$HOME/go"
	export PATH=$PATH:"$HOME/go/bin"
fi

# Python via pyenv
command -v pyenv >/dev/null && eval "$(pyenv init -)"
export PATH="$HOME/.pyenv/shims:$PATH"
PYTHON=$(command -v python)
export PYTHON
export PATH="$HOME/.poetry/bin:$PATH"

#########
# Aliases
#########

# Fix tmux issues
alias less='TERM=xterm less'
alias man='TERM=xterm man'
alias vim='TERM=xterm vim'
alias git='TERM=xterm git'
alias tput='TERM=xterm tput'
alias top='TERM=xterm top'
alias gotop='TERM=xterm gotop'
alias watchexec='TERM=xterm watchexec'
alias bat='TERM=xterm bat'

# Single-letter aliases
alias t='tmux'
alias g='git'
alias h='hx'
alias d='docker'
alias k='kubectl'
alias c='cargo'
alias b='br'

# Replace ls with exa
alias l='exa'
alias ls='exa'
alias la='exa -a'
alias ll='exa -l'
alias lla='exa -la'

# Other helpful/memorable aliases
alias ip='ipconfig getifaddr en0'
alias first='head -1'
alias last='tail -1'
alias hex='hecate'
alias digsimple='dig +nostats +nocomments +nocmd'

###########
# Functions
###########

# r = ripgrep on hidden files with pager
function r {
	rg -.p "$*" | less -R
}

# f = Use fzf to open files in helix
function f {
	result=$(rg --hidden -l "" | fzf --preview 'bat --style=numbers --color=always --line-range :500 {}')
	if [ -z "${result}" ]; then
		# echo "No file selected"
		true
	else
		$EDITOR "${result}"
	fi
}

# ide = Launch "ide": tmux panes with $EDITOR, shell
function ide {
	# Generate session name
	SESSION=${PWD##*/} # Current directory basename
	if tmux has-session -t "$SESSION" 2>/dev/null; then
		COUNTER=2
		SESSION_WITH_SUFFIX="$SESSION-$COUNTER"
		while tmux has-session -t "$SESSION_WITH_SUFFIX" 2>/dev/null; do
			COUNTER=$((COUNTER + 1))
			SESSION_WITH_SUFFIX="$SESSION-$COUNTER"
		done
		SESSION="$SESSION_WITH_SUFFIX"
	fi

	# Create new tmux session
	tmux new-session -s "$SESSION" -d
	tmux send-keys -t "$SESSION" "$EDITOR ." C-m
	tmux split-window -t "$SESSION" -h
	tmux select-pane -L -t "$SESSION"
	tmux attach-session -t "$SESSION"
}
alias i=ide
